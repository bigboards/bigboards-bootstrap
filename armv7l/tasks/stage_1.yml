#- name: install python using CLI to allow ansible to work
#  command: apt-get install -y python

- name: change the user name
  shell: usermod -l bb ubuntu

- name: change the user home directory
  shell: usermod -m -d /home/bb bb

- name: install the software packages
  apt:
    name: "{{ item }}"
    state: "latest"
    update_cache: "yes"
  with_items:
    - curl
    - ntp

- name: make sure we have a correct date
  ignore_errors: yes
  shell: ntpdate -s time.nist.gov

- name: install pip
  shell: curl --silent --show-error --retry 5 https://bootstrap.pypa.io/get-pip.py | sudo python2.7

- name: install the aws tools
  pip:
    name: 'awscli'

- name: set the new bash prompt
  lineinfile: dest=/etc/bash.bashrc regexp='^PS1=' line="PS1=$'\u2b22 {{ hex.name }} \u@\h \w\$ '"

#    - name: chroot - copy the resolv.conf so we have networking
#      copy: src=/etc/resolv.conf dest=/media/bbfs/etc/resolv.conf

#    - name: chroot - bind mount all the filesystems we need
#      shell: for f in /sys /proc /dev ; do mount --rbind $f /media/bbfs$f ; done

- name: configure the network
  template: src=templates/{{item}} dest=/{{item}} owner=root group=root
  with_items:
    - "etc/hostname"
    - "etc/network/interfaces"
    - "etc/dhcp/dhclient.conf"
    - "etc/hosts"

- name: make sure the nodes will register themselves with amazon dns
  template: src=templates/etc/network/if-up.d/dns dest=/etc/network/if-up.d/dns owner=root group=root mode=755

- name: add the bb user to the sudoers
  lineinfile: dest=/etc/sudoers state=present regexp='^bb ALL\=' line='bb ALL=(ALL) NOPASSWD:ALL' validate='visudo -cf %s'